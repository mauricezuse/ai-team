<div *ngIf="workflow" class="card">
  <div class="card-header">
    <h2 data-testid="workflow-title">{{ workflow.name }}</h2>
    <div class="workflow-actions">
      <button pButton type="button" label="Execute" icon="pi pi-play" (click)="executeWorkflow()" 
              [disabled]="workflow.status === 'running'" class="p-button-success" data-testid="execute-button"></button>
      <button pButton type="button" label="Refresh" icon="pi pi-refresh" (click)="refreshWorkflow()" 
              data-testid="refresh-button" class="p-button-outlined"></button>
    </div>
  </div>
  
  <p-toast></p-toast>
  <div class="workflow-info">
    <p><strong>Status:</strong> 
      <span [class]="'status-' + workflow.status" data-testid="workflow-status">{{ workflow.status }}</span>
    </p>
    <p><strong>Created:</strong> {{ workflow.created_at | date:'medium' }}</p>
  </div>

  <div *ngIf="workflow.agents && workflow.agents.length > 0" class="workflow-agents">
    <h3>Agents Involved</h3>
    <div class="agent-chips">
      <span *ngFor="let agent of workflow.agents" class="p-chip">{{ agent }}</span>
    </div>
  </div>

  <div *ngIf="workflow.conversations && workflow.conversations.length > 0" class="conversations-section" data-testid="conversations">
    <h3>Agent Conversations</h3>
    <div class="conversation-filters">
      <input type="text" pInputText placeholder="Search conversations..." 
             [(ngModel)]="searchTerm" (input)="filterConversations()" class="search-input">
      <p-dropdown [options]="agentOptions" optionLabel="label" optionValue="value" [(ngModel)]="selectedAgent" (onChange)="filterConversations()" placeholder="All Agents"></p-dropdown>
      <div class="agent-filter-buttons">
        <button pButton type="button" label="All" (click)="filterByAgent('')" class="p-button-sm p-button-outlined"></button>
        <button pButton type="button" label="Product Manager" (click)="filterByAgent('Product Manager')" class="p-button-sm p-button-outlined"></button>
        <button pButton type="button" label="Solution Architect" (click)="filterByAgent('Solution Architect')" class="p-button-sm p-button-outlined"></button>
        <button pButton type="button" label="Backend Developer" (click)="filterByAgent('Backend Developer')" class="p-button-sm p-button-outlined"></button>
        <button pButton type="button" label="Frontend Developer" (click)="filterByAgent('Frontend Developer')" class="p-button-sm p-button-outlined"></button>
        <button pButton type="button" label="QA Tester" (click)="filterByAgent('QA Tester')" class="p-button-sm p-button-outlined"></button>
      </div>
    </div>
    
    <div class="conversations-list">
      <div *ngFor="let conversation of filteredConversations" 
           class="conversation-item" 
           [attr.data-testid]="'conversation'"
           [attr.data-status]="conversation.status">
        
        <div class="conversation-header">
          <div class="conversation-meta">
            <span class="agent-badge">{{ conversation.agent }}</span>
            <span class="step-badge">{{ conversation.step }}</span>
            <span class="timestamp">{{ conversation.timestamp | date:'short' }}</span>
          </div>
          <button pButton type="button" 
                  [icon]="conversation.expanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                  [attr.data-testid]="conversation.expanded ? 'collapse-button' : 'expand-button'"
                  (click)="toggleConversation(conversation)"
                  class="p-button-text p-button-sm"></button>
        </div>
        
        <div *ngIf="conversation.expanded" class="conversation-details">
          <div *ngIf="conversation.prompt" class="conversation-prompt">
            <strong>Agent Prompt:</strong>
            <div class="prompt-content">
              <pre>{{ conversation.prompt }}</pre>
            </div>
          </div>
          
          <div *ngIf="conversation.details" class="conversation-details-text">
            <strong>Details:</strong> {{ conversation.details }}
          </div>
          <div *ngIf="conversation.output" class="conversation-output">
            <strong>Output:</strong>
            <pre>{{ conversation.output }}</pre>
          </div>
          
          <div *ngIf="conversation.code_files && conversation.code_files.length > 0" class="code-files">
            <strong>Code Files Generated:</strong>
            <p-accordion>
              <p-accordionTab *ngFor="let file of conversation.code_files; let i = index" 
                              [header]="getFileDisplayName(file)" 
                              [selected]="false">
                <div class="code-file-content">
                  <div class="code-file-header">
                    <span class="file-name">
                      <i class="pi pi-file"></i> {{ getFileDisplayName(file) }}
                    </span>
                    <span class="file-path">{{ getFilePath(file) }}</span>
                    <a [href]="getFileUrl(file)" 
                       target="_blank" 
                       class="file-link"
                       data-testid="code-file">
                      <i class="pi pi-external-link"></i> View in Repository
                    </a>
                  </div>
                  <div class="code-preview">
                    <pre><code>{{ getCodePreview(file) }}</code></pre>
                  </div>
                </div>
              </p-accordionTab>
            </p-accordion>
          </div>
          
          <div *ngIf="conversation.escalations && conversation.escalations.length > 0" class="escalations">
            <strong>Escalations:</strong>
            <div *ngFor="let escalation of conversation.escalations" class="escalation-item">
              <span class="escalation-from">{{ escalation.from_agent }} → {{ escalation.to_agent }}</span>
              <span class="escalation-reason">{{ escalation.reason }}</span>
              <span class="escalation-status">{{ escalation.status }}</span>
            </div>
          </div>
          
          <div *ngIf="conversation.collaborations && conversation.collaborations.length > 0" class="collaborations">
            <strong>Collaborations:</strong>
            <div *ngFor="let collaboration of conversation.collaborations" class="collaboration-item">
              <span class="collaboration-from">{{ collaboration.from_agent }} → {{ collaboration.to_agent }}</span>
              <span class="collaboration-type">{{ collaboration.request_type }}</span>
              <span class="collaboration-status">{{ collaboration.status }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!workflow.conversations || workflow.conversations.length === 0" class="no-conversations">
    <p>No conversations yet</p>
  </div>
</div>

<div *ngIf="!workflow">
  <p>Loading...</p>
</div>
