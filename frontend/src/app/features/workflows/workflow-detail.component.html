<div *ngIf="workflow as wf" class="card" data-testid="workflow-detail">
  <div class="card-header">
    <h2 data-testid="workflow-title">{{ wf.name }}</h2>
    <div class="workflow-actions">
      <button pButton type="button" label="Execute" icon="pi pi-play" (click)="executeWorkflow()" 
              [disabled]="wf.status === 'running'" class="p-button-success" data-testid="execute-button"></button>
      <button pButton type="button" label="Refresh" icon="pi pi-refresh" (click)="refreshWorkflow()" 
              data-testid="refresh-button" class="p-button-outlined"></button>
    </div>
  </div>
  
  <p-toast></p-toast>
  <div class="workflow-info">
    <p><strong>Status:</strong> 
      <span [class]="'status-' + wf.status" data-testid="workflow-status">{{ wf.status }}</span>
      <span *ngIf="wf.isTerminal" class="p-chip p-chip-success">Terminal</span>
      <span *ngIf="wf.heartbeat_stale && wf.status === 'running'" class="p-chip p-chip-warning">Stale Heartbeat</span>
    </p>
    <p><strong>Created:</strong> {{ wf.created_at | date:'medium' }}</p>
    <p *ngIf="wf.started_at"><strong>Started:</strong> {{ wf.started_at | date:'medium' }}</p>
    <p *ngIf="wf.finished_at"><strong>Finished:</strong> {{ wf.finished_at | date:'medium' }}</p>
    <p *ngIf="wf.error"><strong>Error:</strong> <span class="error-message">{{ wf.error }}</span></p>
    <p *ngIf="wf.last_heartbeat_at"><strong>Last Heartbeat:</strong> {{ wf.last_heartbeat_at | date:'medium' }}</p>
    <p *ngIf="connectionType"><strong>Connection:</strong> 
      <span class="p-chip" [class]="'p-chip-' + connectionType">{{ connectionType }}</span>
    </p>
    <p>
      <a [routerLink]="['/workflows', wf.id, 'advanced']" class="p-button p-button-outlined" data-testid="advanced-view-link">
        Advanced View
      </a>
      &nbsp;
      <button pButton type="button" label="Start New Execution" icon="pi pi-play" class="p-button-info" (click)="startNewExecution()" data-testid="start-execution"></button>
      &nbsp;
      <button pButton type="button" label="Reconcile Status" icon="pi pi-refresh" class="p-button-warning" (click)="reconcileStatus()" data-testid="reconcile-status" *ngIf="wf.status === 'running'"></button>
    </p>
  </div>

  <div *ngIf="wf.agents && wf.agents.length > 0" class="workflow-agents">
    <h3>Agents Involved</h3>
    <div class="agent-chips">
      <span *ngFor="let agent of wf.agents" class="p-chip">{{ agent }}</span>
    </div>
  </div>

  <p-tabView [(activeIndex)]="activeTabIndex">
    <p-tabPanel header="Overview" data-testid="tab-overview">
      <div class="overview">
        <p><strong>Jira Story:</strong> {{ wf.jira_story_id }} - {{ wf.jira_story_title }}</p>
        <div *ngIf="wf.jira_story_description">
          <strong>Description:</strong>
          <pre>{{ wf.jira_story_description }}</pre>
        </div>
        <div *ngIf="prInfo.url || prInfo.skippedReason" class="pr-summary">
          <p *ngIf="prInfo.url"><strong>PR:</strong> <a [href]="prInfo.url" target="_blank">{{ prInfo.url }}</a></p>
          <p *ngIf="!prInfo.url && prInfo.skippedReason"><strong>PR:</strong> Skipped ({{ prInfo.skippedReason }})</p>
        </div>
        <div *ngIf="allCodeFiles.length > 0" class="code-files-summary">
          <h4>Code Files Changed/Generated</h4>
          <ul>
            <li *ngFor="let file of allCodeFiles">{{ getFileDisplayName(file) }}</li>
          </ul>
        </div>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Executions" data-testid="tab-executions">
      <div class="executions" *ngIf="wf && wf.executions && wf.executions.length > 0">
        <h3>Executions</h3>
        <table class="p-datatable-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Started</th>
              <th>Finished</th>
              <th>Calls</th>
              <th>Tokens</th>
              <th>Cost</th>
              <th>Avg Latency</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let ex of (wf && wf.executions ? wf.executions : [])">
              <td>{{ ex.id }}</td>
              <td>{{ ex.status }}</td>
              <td>{{ ex.started_at | date:'short' }}</td>
              <td>{{ ex.finished_at | date:'short' }}</td>
              <td>{{ ex.total_calls }}</td>
              <td>{{ ex.total_tokens }}</td>
              <td>{{ ex.total_cost }}</td>
              <td>{{ ex.avg_latency_ms }}</td>
            </tr>
          </tbody>
        </table>
        <div class="exec-compare" style="margin-top: 1rem;">
          <h4>Compare Executions</h4>
          <div *ngIf="wf.executions.length > 1; else noCompare">
            <label for="execA">Execution A:</label>
            <select id="execA" [(ngModel)]="execA">
              <option *ngFor="let ex of wf.executions" [ngValue]="ex.id">#{{ ex.id }}</option>
            </select>
            &nbsp;&nbsp;
            <label for="execB">Execution B:</label>
            <select id="execB" [(ngModel)]="execB">
              <option *ngFor="let ex of wf.executions" [ngValue]="ex.id">#{{ ex.id }}</option>
            </select>
            &nbsp;&nbsp;
            <button pButton type="button" label="Compare" (click)="compareExecutions()"></button>
            <div *ngIf="execCompareResult" style="margin-top: .5rem;">
              <pre>{{ execCompareResult | json }}</pre>
            </div>
          </div>
          <ng-template #noCompare>
            <p>No executions yet</p>
          </ng-template>
        </div>
      </div>
      <div *ngIf="!wf || !wf.executions || (wf.executions.length === 0)">
        <p>No executions yet</p>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Conversations" data-testid="tab-conversations">
      <div *ngIf="activeTabIndex === 2 && wf && wf.conversations && wf.conversations.length > 0" class="conversations-section" data-testid="conversations">
        <h3>Agent Conversations</h3>
        <div class="conversation-filters">
          <input type="text" pInputText placeholder="Search conversations..." 
                 [(ngModel)]="searchTerm" (input)="filterConversations()" class="search-input">
          <p-dropdown [options]="agentOptions" optionLabel="label" optionValue="value" [(ngModel)]="selectedAgent" (onChange)="filterConversations()" placeholder="All Agents"></p-dropdown>
          <div class="agent-filter-buttons">
            <button pButton type="button" label="All" (click)="filterByAgent('')" class="p-button-sm p-button-outlined"></button>
            <button pButton type="button" label="Product Manager" (click)="filterByAgent('Product Manager')" class="p-button-sm p-button-outlined"></button>
            <button pButton type="button" label="Solution Architect" (click)="filterByAgent('Solution Architect')" class="p-button-sm p-button-outlined"></button>
            <button pButton type="button" label="Backend Developer" (click)="filterByAgent('Backend Developer')" class="p-button-sm p-button-outlined"></button>
            <button pButton type="button" label="Frontend Developer" (click)="filterByAgent('Frontend Developer')" class="p-button-sm p-button-outlined"></button>
            <button pButton type="button" label="QA Tester" (click)="filterByAgent('QA Tester')" class="p-button-sm p-button-outlined"></button>
          </div>
        </div>
        
        <div class="conversations-list">
          <div *ngFor="let conversation of filteredConversations" 
               class="conversation-item" 
               [attr.data-testid]="'conversation'"
               [attr.data-status]="conversation.status">
            
            <div class="conversation-header">
              <div class="conversation-meta">
                <span class="agent-badge">{{ conversation.agent }}</span>
                <span class="step-badge">{{ conversation.step }}</span>
                <span class="timestamp">{{ conversation.timestamp | date:'short' }}</span>
              </div>
              <button pButton type="button" 
                      [icon]="conversation.expanded ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                      [attr.data-testid]="conversation.expanded ? 'collapse-button' : 'expand-button'"
                      (click)="toggleConversation(conversation)"
                      class="p-button-text p-button-sm"></button>
            </div>
            
            <div *ngIf="conversation.expanded" class="conversation-details">
              <div *ngIf="conversation.prompt" class="conversation-prompt">
                <strong>Agent Prompt:</strong>
                <div class="prompt-content">
                  <pre>{{ conversation.prompt }}</pre>
                </div>
              </div>
              
              <div *ngIf="conversation.details" class="conversation-details-text">
                <strong>Details:</strong> {{ conversation.details }}
              </div>
              <div *ngIf="conversation.output" class="conversation-output">
                <strong>Output:</strong>
                <pre>{{ conversation.output }}</pre>
              </div>
              
              <div *ngIf="conversation.code_files && conversation.code_files.length > 0" class="code-files">
                <strong>Code Files Generated:</strong>
                <p-accordion>
                  <p-accordionTab *ngFor="let file of conversation.code_files; let i = index" 
                                  [header]="getFileDisplayName(file)" 
                                  [selected]="false">
                    <div class="code-file-content">
                      <div class="code-file-header">
                        <span class="file-name">
                          <i class="pi pi-file"></i> {{ getFileDisplayName(file) }}
                        </span>
                        <span class="file-path">{{ getFilePath(file) }}</span>
                        <a [href]="getFileUrl(file)" 
                           target="_blank" 
                           class="file-link"
                           data-testid="code-file">
                          <i class="pi pi-external-link"></i> View in Repository
                        </a>
                      </div>
                      <div class="code-preview">
                        <pre><code>{{ getCodePreview(file) }}</code></pre>
                      </div>
                    </div>
                  </p-accordionTab>
                </p-accordion>
              </div>
              
              <div *ngIf="conversation.escalations && conversation.escalations.length > 0" class="escalations">
                <strong>Escalations:</strong>
                <div *ngFor="let escalation of conversation.escalations" class="escalation-item">
                  <span class="escalation-from">{{ escalation.from_agent }} → {{ escalation.to_agent }}</span>
                  <span class="escalation-reason">{{ escalation.reason }}</span>
                  <span class="escalation-status">{{ escalation.status }}</span>
                </div>
              </div>
              
              <div *ngIf="conversation.collaborations && conversation.collaborations.length > 0" class="collaborations">
                <strong>Collaborations:</strong>
                <div *ngFor="let collaboration of conversation.collaborations" class="collaboration-item">
                  <span class="collaboration-from">{{ collaboration.from_agent }} → {{ collaboration.to_agent }}</span>
                  <span class="collaboration-type">{{ collaboration.request_type }}</span>
                  <span class="collaboration-status">{{ collaboration.status }}</span>
                </div>
              </div>
              
              <div *ngIf="conversation.llm_calls && conversation.llm_calls.length > 0" class="llm-calls">
                <strong>LLM Agent Calls:</strong>
                <div class="llm-summary">
                  <span class="token-usage">Total Tokens: {{ conversation.total_tokens_used }}</span>
                  <span class="cost-usage">Total Cost: ${{ conversation.total_cost }}</span>
                </div>
                <p-accordion>
                  <p-accordionTab *ngFor="let call of conversation.llm_calls; let i = index" 
                                  [header]="getLLMCallHeader(call)" 
                                  [selected]="false">
                    <div class="llm-call-content">
                      <div class="llm-call-header">
                        <div class="call-info">
                          <span class="model-name">{{ call.model }}</span>
                          <span class="call-timestamp">{{ call.timestamp | date:'short' }}</span>
                        </div>
                        <div class="call-metrics">
                          <span class="tokens">{{ call.total_tokens }} tokens</span>
                          <span class="cost">${{ call.cost }}</span>
                          <span class="response-time">{{ call.response_time_ms }}ms</span>
                        </div>
                      </div>
                      
                      <div class="llm-call-details">
                        <div class="request-section">
                          <h4>Request:</h4>
                          <div class="messages">
                            <div *ngFor="let message of call.request_data.messages" class="message">
                              <span class="message-role">{{ message.role }}:</span>
                              <div class="message-content">{{ message.content }}</div>
                            </div>
                          </div>
                        </div>
                        
                        <div class="response-section">
                          <h4>Response:</h4>
                          <div class="response-content">{{ call.response_data.content }}</div>
                        </div>
                        
                        <div class="usage-breakdown">
                          <h4>Token Usage:</h4>
                          <div class="usage-stats">
                            <span>Prompt: {{ call.prompt_tokens }} tokens</span>
                            <span>Completion: {{ call.completion_tokens }} tokens</span>
                            <span>Total: {{ call.total_tokens }} tokens</span>
                          </div>
                        </div>
                <div style="margin-top: .5rem;">
                  <a [routerLink]="['/workflows', wf.id, 'advanced', 'llm-calls']" [queryParams]="{ conversationId: conversation.id }" data-testid="open-llm-calls-from-detail">Open in LLM Calls</a>
                </div>
                      </div>
                    </div>
                  </p-accordionTab>
                </p-accordion>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="activeTabIndex === 2 && (!wf.conversations || wf.conversations.length === 0)" class="no-conversations">
        <p>No conversations yet</p>
      </div>
    </p-tabPanel>

    <p-tabPanel header="LLM Calls" data-testid="tab-llm-calls">
      <div *ngIf="llmConversations.length > 0">
        <label for="llmConv">Conversation:</label>
        <select id="llmConv" [(ngModel)]="llmSelectedConvId">
          <option *ngFor="let conv of llmConversations" [ngValue]="conv.id">{{ conv.label }}</option>
        </select>
        <div class="llm-calls-table" *ngIf="selectedLlmCalls.length > 0">
          <table class="p-datatable-table">
            <thead>
              <tr>
                <th>Model</th>
                <th>Prompt</th>
                <th>Completion</th>
                <th>Total Tokens</th>
                <th>Cost</th>
                <th>Latency</th>
                <th>Timestamp</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let call of selectedLlmCalls">
                <td>{{ call.model }}</td>
                <td>{{ call.prompt_tokens }}</td>
                <td>{{ call.completion_tokens }}</td>
                <td>{{ call.total_tokens }}</td>
                <td>${{ call.cost }}</td>
                <td>{{ call.response_time_ms }}ms</td>
                <td>{{ call.timestamp | date:'short' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="selectedLlmCalls.length === 0">
          <p>No calls found for selected conversation</p>
        </div>
      </div>
      <div *ngIf="llmConversations.length === 0">
        <p>No LLM calls recorded</p>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Escalations" data-testid="tab-escalations">
      <div *ngIf="escalationsList.length > 0">
        <ul>
          <li *ngFor="let e of escalationsList">{{ e.from_agent }} → {{ e.to_agent }} — {{ e.reason }} ({{ e.status }})</li>
        </ul>
      </div>
      <div *ngIf="escalationsList.length === 0">
        <p>No escalations</p>
      </div>
    </p-tabPanel>

    <p-tabPanel header="Code Diffs" data-testid="tab-code-diffs">
      <div *ngIf="activeTabIndex === 5 && allCodeFiles.length > 0">
        <p-accordion>
          <p-accordionTab *ngFor="let file of allCodeFiles" [header]="getFileDisplayName(file)">
            <div class="code-file-content">
              <div class="code-file-header">
                <span class="file-name">
                  <i class="pi pi-file"></i> {{ getFileDisplayName(file) }}
                </span>
                <span class="file-path">{{ getFilePath(file) }}</span>
                <a [href]="getFileUrl(file)" target="_blank" class="file-link">
                  <i class="pi pi-external-link"></i> View in Repository
                </a>
              </div>
              <div class="code-preview">
                <pre><code>{{ getCodePreview(file) }}</code></pre>
              </div>
            </div>
          </p-accordionTab>
        </p-accordion>
      </div>
      <div *ngIf="activeTabIndex === 5 && allCodeFiles.length === 0">
        <p>No code changes detected yet</p>
      </div>
    </p-tabPanel>

    <p-tabPanel header="PR & Checks" data-testid="tab-pr-checks">
      <div *ngIf="prInfo.url; else prMissing">
        <p><strong>Pull Request:</strong> <a [href]="prInfo.url" target="_blank">{{ prInfo.url }}</a></p>
        <div class="checks">
          <p><em>Required status checks:</em> Not available yet — backend integration pending.</p>
        </div>
      </div>
      <ng-template #prMissing>
        <p *ngIf="prInfo.skippedReason; else noPrInfo">PR skipped: {{ prInfo.skippedReason }}</p>
        <ng-template #noPrInfo>
          <p>No PR information available yet</p>
        </ng-template>
      </ng-template>
    </p-tabPanel>

    <p-tabPanel header="Artifacts" data-testid="tab-artifacts">
      <p>No artifacts available yet</p>
    </p-tabPanel>
  </p-tabView>

</div>

<div *ngIf="!workflow">
  <p>Loading...</p>
</div>
